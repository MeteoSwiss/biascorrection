<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calibration of daily forecast time series â€¢ biascorrection</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Calibration of daily forecast time series">
<meta property="og:description" content="biascorrection">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">biascorrection</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.12</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/biascorrection.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://github.com/jonasbhend/biascorrection/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Calibration of daily forecast time series</h1>
                        <h4 class="author">Jonas Bhend</h4>
            
            <h4 class="date">2020-05-13</h4>
      
      <small class="dont-index">Source: <a href="http://github.com/jonasbhend/biascorrection/blob/master/vignettes/biascorrection.Rmd"><code>vignettes/biascorrection.Rmd</code></a></small>
      <div class="hidden name"><code>biascorrection.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This package contains functionality to bias correct (calibrate) daily time series of weather forecasts. In the following two sections we introduce the package and provide instructions to download, install and use the functionality provided in the package. The reminder of the vignette is used to compare the different calibration strategies on synthetic forecast data.</p>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>The latest version of the package along with the accompanying vignette can be installed from github using</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="kw pkg">devtools</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/devtools/man/remote-reexports.html">install_github</a></span>(<span class="st">"jonasbhend/biascorrection"</span>, <span class="kw">build_vignettes</span><span class="kw">=</span><span class="fl">TRUE</span>)</pre></body></html></div>
<p>In case the <code>devtools</code> package is not installed yet, this can be downloaded and installed directly from CRAN.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">'devtools'</span>, <span class="kw">repos</span><span class="kw">=</span><span class="st">'http://cran.rstudio.com'</span>, <span class="kw">dependencies</span><span class="kw">=</span><span class="fl">TRUE</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">devtools</span>)</pre></body></html></div>
</div>
<div id="getting-started" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-started" class="anchor"></a>Getting started</h2>
<p>The following example illustrates how to use the functionality provided in the <code>biascorrection</code> package.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="co">## load the package</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">biascorrection</span>)</pre></body></html></div>
<pre><code>## Loading required package: qmap</code></pre>
<pre><code>## Loading required package: fitdistrplus</code></pre>
<pre><code>## Loading required package: MASS</code></pre>
<pre><code>## Loading required package: survival</code></pre>
<pre><code>## Loading required package: npsurv</code></pre>
<pre><code>## Loading required package: lsei</code></pre>
<pre><code>## Loading required package: easyVerification</code></pre>
<pre><code>## Loading required package: SpecsVerification</code></pre>
<pre><code>## 
## Attaching package: 'easyVerification'</code></pre>
<pre><code>## The following object is masked from 'package:SpecsVerification':
## 
##     EnsCorr</code></pre>
<p>Calibration functions are called using the <code>debias</code> function. The actual functions providing the functionality to bias correct the daily forecast series, however, are hidden from the user as these have common names that may be in use in the global environment. To find out about the visible and invisible functions in the package and thus the functionality provided in the package, you can use the following commands.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="co">## list the visible functions in the package</span>
<span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span>(<span class="kw">pos</span><span class="kw">=</span><span class="st">'package:biascorrection'</span>)</pre></body></html></div>
<pre><code>## [1] "debias"       "debiasApply"  "iqqmap"       "list_methods" "monmean"</code></pre>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="co">## list the calibration methods available in the package</span>
<span class="fu"><a href="../reference/list_methods.html">list_methods</a></span>()</pre></body></html></div>
<pre><code>##  METHODS          DESCRIPTION                                   
##  ccr              Climate Conserving Recalibration              
##  ccrlm            Climate Conserving Recalibration (as          
##                   Regression)                                   
##  comb             Conditional Bias With Linear Time Trend       
##  conditional      Bias Conditional on Forecast                  
##  initial          Bias dependent on initial condition           
##  linmod           Linear Models for Bias Correction             
##  monthly          Daily Calibration with Monthly Mean           
##  moving           Moving Window Mean De-biasing                 
##  mul              Multiplicative De-biasing                     
##  qqmap            Quantile Mapping                              
##  smooth           Mean De-biasing With Smoothing of Daily       
##                   Climatology                                   
##  smooth_mul       Multiplicative De-biasing With Smoothed       
##                   Climatologies                                 
##  smooth_scale     Smoothed Mean De-biasing With Variance Scaling
##  smoothobs_mul    Multiplicative De-biasing With Smoothed       
##                   Observation Climatology                       
##  smoothobs_scale  Mean De-biasing With Variance Scaling         
##  trend            Bias With Linear Time Trend                   
##  useqmap          Quantile Mapping Using the 'qmap' Package</code></pre>
<p>To get started please run the examples provided with the functions (e.g. <code><a href="https://rdrr.io/r/utils/example.html">example(ccr)</a></code>) and check out the corresponding help pages.</p>
</div>
<div id="forecasts-and-observations" class="section level2">
<h2 class="hasAnchor">
<a href="#forecasts-and-observations" class="anchor"></a>Forecasts and observations</h2>
<p>In order to compare the advantages and limitations of the various calibration methods, we compare the calibration methods on forecast observation pairs with set properties. For example, we contrast the calibration with a linear time dependency of the bias (i.e.Â the <code>trend</code> function) with other calibration methods using synthetic forecasts with a linear trend in the bias. That is, we set up a hierarchy of synthetic forecast observation pairs, with increasingly complex error structures. We use forecast and observation pairs for 215 lead times, 30 forecast instances (years) and 15 ensemble members. We start with the most simple forecast observation pairs, where the forecast is unbiased and well calibrated.</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">nlead</span> <span class="kw">&lt;-</span> <span class="fl">215</span>
<span class="no">nfcst</span> <span class="kw">&lt;-</span> <span class="fl">30</span>
<span class="no">nens</span> <span class="kw">&lt;-</span> <span class="fl">15</span>

<span class="co">## seasonal cycle plus an additive signal</span>
<span class="no">signal</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html">outer</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>,<span class="fl">4</span>,<span class="kw">length</span><span class="kw">=</span><span class="no">nlead</span>)), <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">nfcst</span>), <span class="st">'+'</span>)
<span class="no">obs</span> <span class="kw">&lt;-</span> <span class="no">signal</span> + <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">signal</span>))
<span class="no">f</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
<span class="no">f</span><span class="kw">[[</span><span class="st">'unbiased'</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">nlead</span>*<span class="no">nfcst</span>*<span class="no">nens</span>), <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">nlead</span>, <span class="no">nfcst</span>, <span class="no">nens</span>)) + <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">signal</span>)</pre></body></html></div>
<p>Next we add a constant error.</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">f</span><span class="kw">[[</span><span class="st">'constant'</span>]] <span class="kw">&lt;-</span> <span class="no">f</span><span class="kw">[[</span><span class="st">'unbiased'</span>]] + <span class="fl">2</span></pre></body></html></div>
<p>Furthermore, we add a constant error with a smooth seasonal cycle.</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">f</span><span class="kw">[[</span><span class="st">'seasonal'</span>]] <span class="kw">&lt;-</span> <span class="no">f</span><span class="kw">[[</span><span class="st">'unbiased'</span>]] -<span class="fl">2</span> - <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>,<span class="fl">5</span>, <span class="kw">length</span><span class="kw">=</span><span class="no">nlead</span>)*<span class="fl">0.3</span>)</pre></body></html></div>
<p>We continue by adding a linear time trend in the seasonally varying error.</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="no">f</span><span class="kw">[[</span><span class="st">'trend'</span>]] <span class="kw">&lt;-</span> <span class="no">f</span><span class="kw">[[</span><span class="st">'unbiased'</span>]] +
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/outer.html">outer</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>,<span class="fl">4</span>,<span class="kw">length</span><span class="kw">=</span><span class="no">nlead</span>)), <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>,<span class="fl">2</span>,<span class="kw">length</span><span class="kw">=</span><span class="no">nfcst</span>), <span class="st">'+'</span>))</pre></body></html></div>
<p>Finally, we construct a forecast for which the bias depends on the forecasted signal.</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">f</span><span class="kw">[[</span><span class="st">'conditional'</span>]] <span class="kw">&lt;-</span> <span class="no">f</span><span class="kw">[[</span><span class="st">'unbiased'</span>]] + <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1.2</span>*(<span class="no">signal</span> + <span class="fl">2</span>))</pre></body></html></div>
</div>
<div id="calibration-bias-correction" class="section level2">
<h2 class="hasAnchor">
<a href="#calibration-bias-correction" class="anchor"></a>Calibration (bias correction)</h2>
<p>Next we compute the calibrated forecast from the synthetic forecasts using various methods.</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="co">## array with forecast times</span>
<span class="no">fc.time</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="fl">1980</span>+<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>:<span class="no">nfcst</span>, <span class="kw">each</span><span class="kw">=</span><span class="no">nlead</span>), <span class="st">'-11-01'</span>)) -
                   <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">'1981-11-01'</span>) +
                   <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>:<span class="no">nlead</span>, <span class="no">nfcst</span>), <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">nlead</span>, <span class="no">nfcst</span>)) +
  <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">'1981-11-01'</span>)

<span class="no">methods</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'unbias'</span>, <span class="st">'smoothobs'</span>, <span class="st">'smooth'</span>, <span class="st">'trend'</span>, <span class="st">'conditional'</span>)
<span class="no">fcal</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">f</span>, <span class="kw">function</span>(<span class="no">fcst</span>){
  <span class="no">out</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">raw</span><span class="kw">=</span><span class="no">fcst</span>)
  <span class="kw">for</span> (<span class="no">m</span> <span class="kw">in</span> <span class="no">methods</span>) <span class="no">out</span><span class="kw">[[</span><span class="no">m</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/debias.html">debias</a></span>(<span class="no">fcst</span>, <span class="no">obs</span>, <span class="kw">method</span><span class="kw">=</span><span class="no">m</span>, <span class="kw">fc.time</span><span class="kw">=</span><span class="no">fc.time</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">out</span>)
})</pre></body></html></div>
</div>
<div id="skill-of-the-calibrated-forecasts" class="section level2">
<h2 class="hasAnchor">
<a href="#skill-of-the-calibrated-forecasts" class="anchor"></a>Skill of the calibrated forecasts</h2>
<div id="mean-bias" class="section level3">
<h3 class="hasAnchor">
<a href="#mean-bias" class="anchor"></a>Mean bias</h3>
<p>We first analyze the mean bias and the root mean squared error to find out what calibration method works best in what circumstances.</p>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="no">bias</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">fcal</span>, <span class="no">lapply</span>, <span class="kw">function</span>(<span class="no">fcst</span>) <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">fcst</span> - <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">obs</span>)))
<span class="no">rmse</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">fcal</span>, <span class="no">lapply</span>, <span class="kw">function</span>(<span class="no">fcst</span>) <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>((<span class="no">fcst</span> - <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">obs</span>))**<span class="fl">2</span>)))

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mar</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">5</span>,<span class="fl">1</span>,<span class="fl">1</span>))
<span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html">barplot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">rmse</span>, <span class="no">sapply</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>),
        <span class="kw">beside</span><span class="kw">=</span><span class="fl">TRUE</span>,
        <span class="kw">legend</span><span class="kw">=</span><span class="fl">TRUE</span>,
        <span class="kw">args.legend</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">x</span><span class="kw">=</span><span class="st">'topleft'</span>, <span class="kw">inset</span><span class="kw">=</span><span class="fl">0.05</span>, <span class="kw">ncol</span><span class="kw">=</span><span class="fl">2</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">0.83</span>,
                         <span class="kw">bg</span><span class="kw">=</span><span class="st">'white'</span>, <span class="kw">title</span><span class="kw">=</span><span class="st">"Calibration methods"</span>),
        <span class="kw">ylab</span><span class="kw">=</span><span class="st">'Root mean squared error'</span>)</pre></body></html></div>
<p><img src="biascorrection_files/figure-html/unnamed-chunk-11-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div id="correlation" class="section level3">
<h3 class="hasAnchor">
<a href="#correlation" class="anchor"></a>Correlation</h3>
<p>Next we analyse the correlation of the verifying observations with the ensemble mean of the forecasts as a measure of forecast skill.</p>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="no">corr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">fcal</span>, <span class="no">lapply</span>, <span class="kw">function</span>(<span class="no">fcst</span>) <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="no">obs</span>), <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span>(<span class="no">fcst</span>, <span class="kw">dims</span><span class="kw">=</span><span class="fl">2</span>)))))
<span class="no">corr.mn</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">corr</span>, <span class="no">lapply</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/Hyperbolic.html">tanh</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Hyperbolic.html">atanh</a></span>(<span class="no">x</span>))))

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mar</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">5</span>,<span class="fl">1</span>,<span class="fl">1</span>))
<span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html">barplot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">corr.mn</span>, <span class="no">sapply</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>),
        <span class="kw">beside</span><span class="kw">=</span><span class="fl">TRUE</span>,
        <span class="kw">legend</span><span class="kw">=</span><span class="fl">TRUE</span>,
        <span class="kw">args.legend</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">x</span><span class="kw">=</span><span class="st">'bottomleft'</span>, <span class="kw">inset</span><span class="kw">=</span><span class="fl">0.05</span>, <span class="kw">ncol</span><span class="kw">=</span><span class="fl">2</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">0.83</span>,
                         <span class="kw">bg</span><span class="kw">=</span><span class="st">'white'</span>, <span class="kw">title</span><span class="kw">=</span><span class="st">"Calibration methods"</span>),
        <span class="kw">ylab</span><span class="kw">=</span><span class="st">'Lead-time averaged correlation'</span>)</pre></body></html></div>
<p><img src="biascorrection_files/figure-html/unnamed-chunk-12-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div id="continuous-ranked-probability-score" class="section level3">
<h3 class="hasAnchor">
<a href="#continuous-ranked-probability-score" class="anchor"></a>Continuous ranked probability score</h3>
<p>We continue by analyzing a more integrated measure of forecast skill, the continuous ranked probability score (CRPS). CRPS is a generalisation of the mean absolute error for probabilistic forecasts and thus the lower the CRPS, the higher the skill of the forecast.</p>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="no">crpsfun</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">fcst</span>, <span class="no">obs</span>){
  <span class="no">nlead</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">obs</span>)
  <span class="no">nfcst</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">obs</span>)
  <span class="no">nens</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(<span class="no">fcst</span>)[<span class="fl">3</span>]
  <span class="no">crps.out</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(<span class="no">obs</span>))
  <span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="no">nlead</span>){
    <span class="no">crps.out</span>[<span class="no">i</span>,] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">nfcst</span>, <span class="kw">function</span>(<span class="no">n</span>) <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="no">fcst</span>[<span class="no">i</span>,<span class="no">n</span>,] - <span class="no">obs</span>[<span class="no">i</span>,<span class="no">n</span>])) -
                             <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span>(<span class="no">fcst</span>[<span class="no">i</span>,<span class="no">n</span>,]))/<span class="no">nens</span>/<span class="no">nens</span>)
  }
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">crps.out</span>)
}
<span class="no">crps</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">fcal</span>, <span class="no">lapply</span>, <span class="no">crpsfun</span>, <span class="kw">obs</span><span class="kw">=</span><span class="no">obs</span>)
<span class="no">crps.mn</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">crps</span>, <span class="no">lapply</span>, <span class="no">mean</span>)

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mar</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">5</span>,<span class="fl">1</span>,<span class="fl">1</span>))
<span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html">barplot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">crps.mn</span>, <span class="no">sapply</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>),
        <span class="kw">beside</span><span class="kw">=</span><span class="fl">TRUE</span>,
        <span class="kw">legend</span><span class="kw">=</span><span class="fl">TRUE</span>,
        <span class="kw">args.legend</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">x</span><span class="kw">=</span><span class="st">'topleft'</span>, <span class="kw">inset</span><span class="kw">=</span><span class="fl">0.05</span>, <span class="kw">ncol</span><span class="kw">=</span><span class="fl">2</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">0.83</span>,
                         <span class="kw">bg</span><span class="kw">=</span><span class="st">'white'</span>, <span class="kw">title</span><span class="kw">=</span><span class="st">"Calibration methods"</span>),
        <span class="kw">ylab</span><span class="kw">=</span><span class="st">'mean CRPS'</span>)</pre></body></html></div>
<p><img src="biascorrection_files/figure-html/unnamed-chunk-13-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div id="spread-to-error-ratio" class="section level3">
<h3 class="hasAnchor">
<a href="#spread-to-error-ratio" class="anchor"></a>Spread to error ratio</h3>
<p>Finally, lets compute the spread to error ratio as a measure of whether the forecasts are reliable, that is, whether forecast probabilities are equal to observed frequencies on average. A spread to error ratio of about 1 is a necessary (but not sufficient) condition for the forecasts to be reliable. Forecasts with a spread to error ratio of less than 1 are called overconfident, meaning that the verifying observations lie more often oustide the envelope of forecasts than expected. As none of the calibration methods analysed here affects the intra ensemble spread of the forecasts, the spread to error ratio basically is a function of the mean squared error (with respect to the ensemble mean) of the forecasts. Therefore, the spread to error ratio indicates how well the calibration methods are able to remove systematic biases.</p>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="no">sprerrfun</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">fcst</span>, <span class="no">obs</span>){
  <span class="no">nlead</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">obs</span>)
  <span class="no">nfcst</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">obs</span>)
  <span class="no">nens</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(<span class="no">fcst</span>)[<span class="fl">3</span>]
  <span class="no">spr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">fcst</span>, <span class="fl">1</span>:<span class="fl">2</span>, <span class="no">sd</span>)**<span class="fl">2</span>, <span class="fl">1</span>, <span class="no">mean</span>)
  <span class="no">err</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>((<span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span>(<span class="no">fcst</span>, <span class="kw">dims</span><span class="kw">=</span><span class="fl">2</span>) - <span class="no">obs</span>)**<span class="fl">2</span>, <span class="fl">1</span>, <span class="no">mean</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>((<span class="no">nens</span> + <span class="fl">1</span>)/<span class="no">nens</span> * <span class="no">spr</span> / <span class="no">err</span>))
}

<span class="no">sprerr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">fcal</span>, <span class="no">lapply</span>, <span class="no">sprerrfun</span>, <span class="kw">obs</span><span class="kw">=</span><span class="no">obs</span>)
<span class="no">sprerr.mn</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">sprerr</span>, <span class="no">lapply</span>, <span class="no">mean</span>)

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mar</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">5</span>,<span class="fl">1</span>,<span class="fl">1</span>))
<span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html">barplot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">sprerr.mn</span>, <span class="no">sapply</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>),
        <span class="kw">beside</span><span class="kw">=</span><span class="fl">TRUE</span>,
        <span class="kw">legend</span><span class="kw">=</span><span class="fl">TRUE</span>,
        <span class="kw">args.legend</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">x</span><span class="kw">=</span><span class="st">'bottomleft'</span>, <span class="kw">inset</span><span class="kw">=</span><span class="fl">0.05</span>, <span class="kw">ncol</span><span class="kw">=</span><span class="fl">2</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">0.83</span>,
                         <span class="kw">bg</span><span class="kw">=</span><span class="st">'white'</span>, <span class="kw">title</span><span class="kw">=</span><span class="st">"Calibration methods"</span>),
        <span class="kw">ylab</span><span class="kw">=</span><span class="st">'mean spread to error ratio'</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">h</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">lwd</span><span class="kw">=</span><span class="fl">2</span>, <span class="kw">lty</span><span class="kw">=</span><span class="fl">2</span>)</pre></body></html></div>
<p><img src="biascorrection_files/figure-html/unnamed-chunk-14-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Here we find that calibrated forecasts with simple additive biases (e.g.Â the <code>unbiased</code>, <code>constant</code> and <code>seasonal</code> cases) are rendered reliable using all calibration methods. Forecasts with a trend in the bias or a bias dependent on the signal are only reliable when calibrated with the corresponding calibration method. With all other calibration methods, biases remain and thus the mean squared error is much larger than the average spread of the forecasts.</p>
</div>
</div>
<div id="non-parametric-calibration-quantile-mapping" class="section level2">
<h2 class="hasAnchor">
<a href="#non-parametric-calibration-quantile-mapping" class="anchor"></a>Non-parametric calibration (quantile mapping)</h2>
<p>So far, we have only calibrated biases in the mean, assuming the higher moments of the forecast distribution are unbiased with respect to the verifying observations. Using quantile mapping, calibration can be extended to the full forecast distribution in a non-parametric way. As the name implies, forecasts are mapped to observed quantiles according to the forecast quantiles in which they fall. To compare quantile mapping with other calibration methods, we set up a new set of synthetic forecasts with daily variability that is markedly different from the observed daily variability.</p>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="co">## set up forecast with uniformly distributed daily values</span>
<span class="no">fcal</span><span class="kw">[[</span><span class="st">'unif'</span>]]<span class="kw">[[</span><span class="st">'raw'</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="no">nlead</span>*<span class="no">nfcst</span>*<span class="no">nens</span>, <span class="kw">min</span><span class="kw">=</span>-<span class="fl">0.5</span>, <span class="kw">max</span><span class="kw">=</span><span class="fl">0.5</span>),
                                 <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">nlead</span>, <span class="no">nfcst</span>, <span class="no">nens</span>)) + <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">signal</span>)

<span class="co">## calibrate forecast using different methods</span>
<span class="no">methods</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'unbias'</span>, <span class="st">'smoothobs'</span>, <span class="st">'smooth'</span>, <span class="st">'trend'</span>, <span class="st">'conditional'</span>)
<span class="kw">for</span> (<span class="no">m</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">methods</span>, <span class="st">'qqmap'</span>)){
  <span class="no">fcal</span>$<span class="no">unif</span><span class="kw">[[</span><span class="no">m</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/debias.html">debias</a></span>(<span class="no">fcal</span><span class="kw">[[</span><span class="st">'unif'</span>]]<span class="kw">[[</span><span class="st">'raw'</span>]], <span class="no">obs</span>,
                           <span class="kw">method</span><span class="kw">=</span><span class="no">m</span>, <span class="kw">fc.time</span><span class="kw">=</span><span class="no">fc.time</span>, <span class="kw">anomalies</span><span class="kw">=</span><span class="fl">TRUE</span>)
}

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mar</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">4.5</span>,<span class="fl">4.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>))
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="no">obs</span>), <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="no">fcal</span>$<span class="no">unif</span>$<span class="no">raw</span>[,,<span class="fl">1</span>]), <span class="kw">lwd</span><span class="kw">=</span><span class="fl">2</span>, <span class="kw">asp</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">'l'</span>,
     <span class="kw">xlab</span><span class="kw">=</span><span class="st">'Observed quantiles'</span>, <span class="kw">ylab</span><span class="kw">=</span><span class="st">'Forecast quantiles (member 1)'</span>, <span class="kw">las</span><span class="kw">=</span><span class="fl">1</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>), <span class="kw">lwd</span><span class="kw">=</span><span class="fl">2</span>, <span class="kw">lty</span><span class="kw">=</span><span class="fl">2</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="no">obs</span>), <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="no">fcal</span>$<span class="no">unif</span>$<span class="no">qqmap</span>[,,<span class="fl">1</span>]), <span class="kw">lwd</span><span class="kw">=</span><span class="fl">2</span>, <span class="kw">col</span><span class="kw">=</span><span class="fl">2</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span>(<span class="st">'bottomright'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Raw forecast"</span>, <span class="st">"Calibrated forecast (qqmap)"</span>),
       <span class="kw">lwd</span><span class="kw">=</span><span class="fl">2</span>, <span class="kw">col</span><span class="kw">=</span><span class="fl">1</span>:<span class="fl">2</span>, <span class="kw">bty</span><span class="kw">=</span><span class="st">'n'</span>)</pre></body></html></div>
<p><img src="biascorrection_files/figure-html/unnamed-chunk-15-1.png" width="384" style="display: block; margin: auto;"></p>
<p>We do not repeat all verification metrics shown above but directly summarize and compare the quantile mapping with other calibration methods using the mean CRPS and spread to error ratio.</p>
<div class="sourceCode" id="cb29"><html><body><pre class="r"><span class="no">funifscore</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
<span class="no">funifscore</span><span class="kw">[[</span><span class="st">'mean CRPS'</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">fcal</span>$<span class="no">unif</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="fu">crpsfun</span>(<span class="no">x</span>, <span class="no">obs</span>)))
<span class="no">funifscore</span><span class="kw">[[</span><span class="st">'mean spread to error'</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">fcal</span>$<span class="no">unif</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="fu">sprerrfun</span>(<span class="no">x</span>, <span class="no">obs</span>)))

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mar</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">5</span>,<span class="fl">1</span>,<span class="fl">1</span>))
<span class="no">tmp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html">barplot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">funifscore</span>, <span class="no">unlist</span>),
        <span class="kw">beside</span><span class="kw">=</span><span class="fl">TRUE</span>, <span class="kw">las</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">legend</span><span class="kw">=</span><span class="fl">TRUE</span>, <span class="kw">ylim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1.6</span>),
        <span class="kw">args.legend</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">x</span><span class="kw">=</span><span class="st">'topleft'</span>, <span class="kw">inset</span><span class="kw">=</span><span class="fl">0.05</span>, <span class="kw">ncol</span><span class="kw">=</span><span class="fl">4</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">0.83</span>,
                         <span class="kw">bg</span><span class="kw">=</span><span class="st">'white'</span>, <span class="kw">title</span><span class="kw">=</span><span class="st">"Calibration methods"</span>),
        <span class="kw">ylab</span><span class="kw">=</span><span class="st">'CRPS / spread to error ratio'</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span>(<span class="no">tmp</span>[,<span class="fl">2</span>]) + <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">0.5</span>,<span class="fl">0.5</span>)*<span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span>(<span class="no">tmp</span>[,<span class="fl">2</span>])),
      <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>,<span class="fl">2</span>), <span class="kw">lwd</span><span class="kw">=</span><span class="fl">2</span>, <span class="kw">lty</span><span class="kw">=</span><span class="fl">2</span>)</pre></body></html></div>
<p><img src="biascorrection_files/figure-html/unnamed-chunk-16-1.png" width="576" style="display: block; margin: auto;"></p>
<p>While the CRPS is only slightly lower using quantile mapping compared to other calibration methods that do not affect intra-ensemble spread, the spread to error ratio indicates that quantile mapping is the only one of these calibration methods that produces reliable forecasts.</p>
</div>
<div id="climate-conserving-recalibration" class="section level2">
<h2 class="hasAnchor">
<a href="#climate-conserving-recalibration" class="anchor"></a>Climate conserving recalibration</h2>
<p>Instead of adjusting the properties of the daily variability in forecasts and thereby achieving reliable forecasts in an ad hoc way, we can also use a more targeted calibration framework to render forecasts reliable. This climate conserving recalibration (<span class="citation">@Weigel2008</span>) adjusts the ensemble mean (the predictable signal) and the intra-ensemble spread simultaneously to render reliable forecasts. To test the climate conserving recalibration we set up an over- and under-confident forecast and calibrate and verify these forecasts as in the examples in the previous sections.</p>
<div class="sourceCode" id="cb30"><html><body><pre class="r"><span class="co">## set up under- and over-confident forecasts (no bias)</span>
<span class="no">fcal</span><span class="kw">[[</span><span class="st">'over'</span>]]<span class="kw">[[</span><span class="st">'raw'</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">nlead</span>*<span class="no">nfcst</span>*<span class="no">nens</span>, <span class="kw">sd</span><span class="kw">=</span><span class="fl">0.5</span>),
                                 <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">nlead</span>, <span class="no">nfcst</span>, <span class="no">nens</span>)) + <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">signal</span>)
<span class="no">fcal</span><span class="kw">[[</span><span class="st">'under'</span>]]<span class="kw">[[</span><span class="st">'raw'</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">nlead</span>*<span class="no">nfcst</span>*<span class="no">nens</span>, <span class="kw">sd</span><span class="kw">=</span><span class="fl">2</span>),
                                  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">nlead</span>, <span class="no">nfcst</span>, <span class="no">nens</span>)) + <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">signal</span>)

<span class="co">## calibrate forecast using different methods</span>
<span class="kw">for</span> (<span class="no">m</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">methods</span>, <span class="st">'qqmap'</span>, <span class="st">'ccr'</span>)){
  <span class="kw">for</span> (<span class="no">conf</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'over'</span>, <span class="st">'under'</span>)){
    <span class="no">fcal</span><span class="kw">[[</span><span class="no">conf</span>]]<span class="kw">[[</span><span class="no">m</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/debias.html">debias</a></span>(<span class="no">fcal</span><span class="kw">[[</span><span class="no">conf</span>]]<span class="kw">[[</span><span class="st">'raw'</span>]], <span class="no">obs</span>,
                                <span class="kw">method</span><span class="kw">=</span><span class="no">m</span>, <span class="kw">fc.time</span><span class="kw">=</span><span class="no">fc.time</span>, <span class="kw">anomalies</span><span class="kw">=</span><span class="fl">TRUE</span>)
    }
  }

<span class="no">fconfscore</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
<span class="kw">for</span> (<span class="no">conf</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'over'</span>, <span class="st">'under'</span>)){
  <span class="no">fconfscore</span><span class="kw">[[</span><span class="no">conf</span>]]<span class="kw">[[</span><span class="st">'mean CRPS'</span>]] <span class="kw">&lt;-</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">fcal</span><span class="kw">[[</span><span class="no">conf</span>]], <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="fu">crpsfun</span>(<span class="no">x</span>, <span class="no">obs</span>)))
  <span class="no">fconfscore</span><span class="kw">[[</span><span class="no">conf</span>]]<span class="kw">[[</span><span class="st">'mean spread to error'</span>]] <span class="kw">&lt;-</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">fcal</span><span class="kw">[[</span><span class="no">conf</span>]], <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="fu">sprerrfun</span>(<span class="no">x</span>, <span class="no">obs</span>)))
  }

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mfrow</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2</span>,<span class="fl">1</span>), <span class="kw">mar</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">5</span>,<span class="fl">1</span>,<span class="fl">1</span>), <span class="kw">oma</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>))
<span class="kw">for</span> (<span class="no">nm</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">fconfscore</span>$<span class="no">over</span>)){
  <span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html">barplot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="kw">`over-confident ensemble`</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="no">fconfscore</span>$<span class="no">over</span><span class="kw">[[</span><span class="no">nm</span>]]),
                <span class="kw">`under-confident ensemble`</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="no">fconfscore</span>$<span class="no">under</span><span class="kw">[[</span><span class="no">nm</span>]])),
          <span class="kw">beside</span><span class="kw">=</span><span class="fl">TRUE</span>, , <span class="kw">las</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">legend</span><span class="kw">=</span>(<span class="no">nm</span> <span class="kw">==</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">fconfscore</span>$<span class="no">over</span>)[<span class="fl">1</span>]),
          <span class="kw">args.legend</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">x</span><span class="kw">=</span><span class="st">'bottomleft'</span>, <span class="kw">inset</span><span class="kw">=</span><span class="fl">0.05</span>, <span class="kw">ncol</span><span class="kw">=</span><span class="fl">3</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">1</span>,
                           <span class="kw">bg</span><span class="kw">=</span><span class="st">'white'</span>, <span class="kw">title</span><span class="kw">=</span><span class="st">"Calibration methods"</span>),
          <span class="kw">ylab</span><span class="kw">=</span><span class="no">nm</span>)
  <span class="kw">if</span> (<span class="no">nm</span> <span class="kw">==</span> <span class="st">'mean spread to error'</span>) <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">h</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">lwd</span><span class="kw">=</span><span class="fl">2</span>, <span class="kw">lty</span><span class="kw">=</span><span class="fl">2</span>)

  }</pre></body></html></div>
<p><img src="biascorrection_files/figure-html/unnamed-chunk-17-1.png" width="480" style="display: block; margin: auto;"></p>
<p>We find that the CRPS is slightly reduced using the recalibration method compared to other calibration methods that do not affect the intra-ensemble spread. The spread to erro ratio, on the other hand is significantly modified with the CCR methods with and without smoothing (<code>ccr</code> and <code>smoothccr</code> respectively). The spread to error ratio of these recalibration methods is very close to one indicating that the recalibrated forecasts may in fact be reliable (note that unity of the spread error ratio is only a necessary but not sufficient condition for reliability). Reliability of daily series, however, does not necessarily imply that forecasts of derived or aggregated quantities such as seasonal averages are reliable after recalibration on the daily series as well. This is illustrated in the following Figure.</p>
<div class="sourceCode" id="cb31"><html><body><pre class="r"><span class="co">## aggregate the calibrated (and raw) series to monthly and seasonal</span>
<span class="co">## assuming 30-day months</span>
<span class="no">fmon</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">fcal</span>, <span class="no">lapply</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span>(<span class="no">x</span>[<span class="fl">1</span>:<span class="fl">210</span>,,], <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">30</span>,<span class="fl">7</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(<span class="no">x</span>)[-<span class="fl">1</span>])), <span class="kw">dims</span><span class="kw">=</span><span class="fl">1</span>))
<span class="no">fseas</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">fmon</span>, <span class="no">lapply</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">x</span>, <span class="fl">2</span>:<span class="fl">3</span>, <span class="no">filter</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>/<span class="fl">3</span>, <span class="fl">3</span>))[-<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">7</span>),,])
<span class="no">omon</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span>(<span class="no">obs</span>[<span class="fl">1</span>:<span class="fl">210</span>,], <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">30</span>,<span class="fl">7</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">obs</span>))), <span class="kw">dims</span><span class="kw">=</span><span class="fl">1</span>)
<span class="no">oseas</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">omon</span>, <span class="fl">2</span>, <span class="no">filter</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>/<span class="fl">3</span>,<span class="fl">3</span>))[-<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">7</span>),]

<span class="co">## compute crps and spread to error</span>
<span class="no">fseasscore</span> <span class="kw">&lt;-</span> <span class="no">fmonscore</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
<span class="kw">for</span> (<span class="no">score</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"mean CRPS"</span>, <span class="st">'mean spread to error'</span>)){
  <span class="kw">if</span> (<span class="no">score</span> <span class="kw">==</span> <span class="st">'mean CRPS'</span>){
    <span class="no">sfun</span> <span class="kw">&lt;-</span> <span class="no">crpsfun</span>
  } <span class="kw">else</span> {
    <span class="no">sfun</span> <span class="kw">&lt;-</span> <span class="no">sprerrfun</span>
  }
  <span class="no">fseasscore</span><span class="kw">[[</span><span class="no">score</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">fseas</span>, <span class="no">lapply</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="fu">sfun</span>(<span class="no">x</span>, <span class="no">oseas</span>)))
  <span class="no">fmonscore</span><span class="kw">[[</span><span class="no">score</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">fmon</span>, <span class="no">lapply</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="fu">sfun</span>(<span class="no">x</span>, <span class="no">omon</span>)))
  }

<span class="no">dd</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
<span class="kw">for</span> (<span class="no">nm</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'over'</span>, <span class="st">'under'</span>)){
  <span class="no">dd</span><span class="kw">[[</span><span class="no">nm</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="kw">daily</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="no">fconfscore</span><span class="kw">[[</span><span class="no">nm</span>]]<span class="kw">[[</span><span class="st">'mean spread to error'</span>]]),
                    <span class="kw">monthly</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="no">fmonscore</span><span class="kw">[[</span><span class="st">'mean spread to error'</span>]]<span class="kw">[[</span><span class="no">nm</span>]]),
                    <span class="kw">seasonal</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="no">fseasscore</span><span class="kw">[[</span><span class="st">'mean spread to error'</span>]]<span class="kw">[[</span><span class="no">nm</span>]]))
  }


<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mfrow</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">2</span>), <span class="kw">mar</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.5</span>, <span class="fl">3</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>), <span class="kw">oma</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.5</span>,<span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">0.5</span>))
<span class="kw">for</span> (<span class="no">nm</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">dd</span>)){
  <span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html">barplot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="no">dd</span><span class="kw">[[</span><span class="no">nm</span>]][-<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2</span>:<span class="fl">3</span>,<span class="fl">5</span>:<span class="fl">6</span>),]), <span class="kw">beside</span><span class="kw">=</span><span class="fl">TRUE</span>, <span class="kw">legend</span><span class="kw">=</span>(<span class="no">nm</span> <span class="kw">==</span> <span class="st">'over'</span>), <span class="kw">ylim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span>(<span class="fl">0</span>, <span class="no">dd</span>), <span class="kw">las</span><span class="kw">=</span><span class="fl">1</span>,
          <span class="kw">args.legend</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">x</span><span class="kw">=</span><span class="st">'bottomleft'</span>, <span class="kw">inset</span><span class="kw">=</span><span class="fl">0.05</span>, <span class="kw">ncol</span><span class="kw">=</span><span class="fl">3</span>, <span class="kw">cex</span><span class="kw">=</span><span class="fl">0.83</span>,
                           <span class="kw">bg</span><span class="kw">=</span><span class="st">'white'</span>, <span class="kw">title</span><span class="kw">=</span><span class="st">"Temporal averaging"</span>))
  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">h</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">lwd</span><span class="kw">=</span><span class="fl">2</span>, <span class="kw">lty</span><span class="kw">=</span><span class="fl">2</span>)
  <span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span>(<span class="fl">3</span>, <span class="kw">at</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="st">'usr'</span>)[<span class="fl">1</span>], <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">letters</span>[<span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span>(<span class="no">nm</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">dd</span>))],
                                   <span class="st">') '</span>, <span class="no">nm</span>, <span class="st">'-confident ensemble'</span>),
       <span class="kw">hadj</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">tick</span><span class="kw">=</span><span class="fl">FALSE</span>, <span class="kw">line</span><span class="kw">=</span>-<span class="fl">0.5</span>)
  <span class="kw">if</span> (<span class="no">nm</span> <span class="kw">==</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">dd</span>)[<span class="fl">1</span>]) <span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span>(<span class="fl">2</span>, <span class="kw">at</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="st">'usr'</span>)[<span class="fl">3</span>:<span class="fl">4</span>]),
                               <span class="st">'mean spread to error ratio'</span>,
                               <span class="kw">tick</span><span class="kw">=</span><span class="fl">FALSE</span>, <span class="kw">line</span><span class="kw">=</span><span class="fl">2</span>)
}</pre></body></html></div>
<p><img src="biascorrection_files/figure-html/unnamed-chunk-18-1.png" width="768" style="display: block; margin: auto;"></p>
<p>Here we find that the recalibration of daily series from an over-confident ensemble results in a spread to error ratio very close to unity for the daily, monthly and seasonal forecasts. In contrast, recalibration of an uncer-confident ensemble results in decidedly over-confident monthly and seasonal forecasts derived from the recalibrated daily series. This is an effect of the limited ensemble and forecast size and the thus resulting sampling uncertainty of the mean signal and its correlation with the observations. Due to the sampling uncertainty of correlation, the daily recalibration affects both the intra-ensemble variability and the mean signal, even though the mean signal is unbiased and should not be affected. Sampling uncertainty is less of a problem with over-confident forecasts, as the samping uncertainty in the ensemble mean of an over-confident forecast is smaller due to the lack of intra-ensemble variance. Real forecasts, however, do not follow the simple model of over- and under-confidence as used here, and thus the conclusions drawn from our analysis of synthetic forecast observation pairs may only hold to the extent that recalibration of daily series does not necessarily lead to well calibrated (reliable) forecasts of aggregated or derived indices from the recalibrated daily series.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jonas Bhend.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
